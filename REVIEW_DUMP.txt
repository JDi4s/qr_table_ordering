===== config/routes.rb =====
Rails.application.routes.draw do
  # -------------------------
  # Authentication
  # -------------------------
  get    "login",  to: "sessions#new"
  post   "login",  to: "sessions#create"
  delete "logout", to: "sessions#destroy"

  # -------------------------
  # Customer (QR access)
  # -------------------------
  resources :tables, only: [] do
    resources :orders, only: [:new, :create, :show]
  end

  # -------------------------
  # Staff area
  # -------------------------
  namespace :staff do
    resources :orders, only: [:index, :show, :update]

    resources :tables, only: [:index] do
      member do
        get :qr_code
      end
    end

    resources :menu_items
    resources :categories
  end

  resources :order_items, only: [:update]


  # -------------------------
  # Health check
  # -------------------------
  get "up" => "rails/health#show", as: :rails_health_check

  # -------------------------
  # Root (Option A)
  # -------------------------
  root "sessions#new"
end

===== Gemfile =====
source "https://rubygems.org"

ruby "3.3.5"

# Bundle edge Rails instead: gem "rails", github: "rails/rails", branch: "main"
gem "rails", "~> 7.1.6"

# The original asset pipeline for Rails [https://github.com/rails/sprockets-rails]
gem "sprockets-rails"

# Use postgresql as the database for Active Record
gem "pg", "~> 1.1"

# Use the Puma web server [https://github.com/puma/puma]
gem "puma", ">= 5.0"

# Use JavaScript with ESM import maps [https://github.com/rails/importmap-rails]
gem "importmap-rails"

# Hotwire's SPA-like page accelerator [https://turbo.hotwired.dev]
gem "turbo-rails"

# Hotwire's modest JavaScript framework [https://stimulus.hotwired.dev]
gem "stimulus-rails"

# Build JSON APIs with ease [https://github.com/rails/jbuilder]
gem "jbuilder"

# Use Redis adapter to run Action Cable in production
# gem "redis", ">= 4.0.1"

# Use Kredis to get higher-level data types in Redis [https://github.com/rails/kredis]
# gem "kredis"

# Use Active Model has_secure_password [https://guides.rubyonrails.org/active_model_basics.html#securepassword]
# gem "bcrypt", "~> 3.1.7"

# Windows does not include zoneinfo files, so bundle the tzinfo-data gem
gem "tzinfo-data", platforms: %i[ windows jruby ]

# Reduces boot times through caching; required in config/boot.rb
gem "bootsnap", require: false

gem 'bcrypt', '~> 3.1.18'
gem 'rqrcode'





# Use Active Storage variants [https://guides.rubyonrails.org/active_storage_overview.html#transforming-images]
# gem "image_processing", "~> 1.2"

group :development, :test do
  # See https://guides.rubyonrails.org/debugging_rails_applications.html#debugging-with-the-debug-gem
  gem "debug", platforms: %i[ mri windows ]
end

group :development do
  # Use console on exceptions pages [https://github.com/rails/web-console]
  gem "web-console"

  # Add speed badges [https://github.com/MiniProfiler/rack-mini-profiler]
  # gem "rack-mini-profiler"

  # Speed up commands on slow machines / big apps [https://github.com/rails/spring]
  # gem "spring"
end

group :test do
  # Use system testing [https://guides.rubyonrails.org/testing.html#system-testing]
  gem "capybara"
  gem "selenium-webdriver"
end

===== app/models (all) =====

----- app/models/application_record.rb -----
class ApplicationRecord < ActiveRecord::Base
  primary_abstract_class
end

----- app/models/category.rb -----
class Category < ApplicationRecord
  has_many :menu_items, dependent: :destroy

  validates :name, presence: true
end

----- app/models/menu_item.rb -----
class MenuItem < ApplicationRecord
  belongs_to :category
  has_many :order_items
  has_many :orders, through: :order_items

  validates :name, presence: true
  validates :price, presence: true, numericality: { greater_than_or_equal_to: 0 }
end

----- app/models/order_item.rb -----
class OrderItem < ApplicationRecord
  belongs_to :order
  belongs_to :menu_item

  enum status: { pending: "pending", accepted: "accepted", denied: "denied" }

  validates :quantity, numericality: { greater_than: 0 }

  after_update_commit :broadcast_customer_item_update

  private

  def broadcast_customer_item_update
    broadcast_replace_to(
    "order_#{order_id}",
    target: dom_id(self),
    partial: "orders/order_item",
    locals: { oi: self }
    )
  end


end

----- app/models/order.rb -----
# app/models/order.rb
class Order < ApplicationRecord
  include ActionView::RecordIdentifier

  belongs_to :table
  has_many :order_items, dependent: :destroy
  has_many :menu_items, through: :order_items

  accepts_nested_attributes_for :order_items

  enum status: {
    pending: "pending",
    accepted: "accepted",
    processing: "processing",
    denied: "denied"
  }

  before_validation :set_default_status, on: :create
  after_update_commit :broadcast_customer_update

  private

  def set_default_status
    self.status ||= "pending"
  end

  def broadcast_customer_update
    broadcast_replace_to(
      "order_#{id}",
      target: dom_id(self),
      partial: "orders/order",
      locals: { order: self, table: table }
    )
  end
end

----- app/models/table.rb -----
class Table < ApplicationRecord
  has_many :orders, dependent: :destroy
  before_create :generate_qr_token
  validates :number, presence: true, uniqueness: true
  validates :qr_token, uniqueness: true


  # Use QR token in URLs instead of numeric ID
  def to_param
    qr_token
  end

  def qr_code
    require 'rqrcode'
    url = Rails.application.routes.url_helpers.new_table_order_url(self.qr_token, host: "localhost:3000")
    qrcode = RQRCode::QRCode.new(url)
    qrcode.as_svg(
    offset: 0,
    color: '000',
    shape_rendering: 'crispEdges',
    module_size: 6,
    standalone: true
    )
  end

  private

  def generate_qr_token
    self.qr_token = SecureRandom.hex(5) if qr_token.blank?
  end
end

----- app/models/user.rb -----
class User < ApplicationRecord
  has_secure_password

  enum role: { staff: "staff", admin: "admin" }
  validates :email, presence: true, uniqueness: true
end

===== app/controllers (top-level) =====

----- app/controllers/application_controller.rb -----
class ApplicationController < ActionController::Base
end

----- app/controllers/orders_controller.rb -----
class OrdersController < ApplicationController
  before_action :set_table

  def new
    @order = @table.orders.new
    @categories = Category.includes(:menu_items).all
  end

  def create
    raw_items = params.dig(:order, :order_items_attributes) || {}

    items = raw_items.values.map do |h|
      menu_item_id = h[:menu_item_id].presence
      qty = h[:quantity].to_i

      next if menu_item_id.blank?
      next if qty <= 0

      { menu_item_id: menu_item_id, quantity: qty }
    end.compact

    @order = @table.orders.new

    if items.empty?
      @categories = Category.includes(:menu_items).all
      flash.now[:alert] = "Select at least one item"
      render :new, status: :unprocessable_entity
      return
    end

    items.each { |item| @order.order_items.build(item) }

    if @order.save
      redirect_to table_order_path(@table.qr_token, @order), notice: "Order submitted successfully"
    else
      @categories = Category.includes(:menu_items).all
      render :new, status: :unprocessable_entity
    end
  end

  def show
    @order = @table.orders.includes(order_items: :menu_item).find(params[:id])
  end

  private

  def set_table
    @table = Table.find_by!(qr_token: params[:table_id])
  end
end

----- app/controllers/sessions_controller.rb -----
class SessionsController < ApplicationController
  def new
  end

  def create
  user = User.find_by(email: params[:email])

  if user&.authenticate(params[:password]) && user.staff?
    session[:user_id] = user.id
    redirect_to staff_orders_path, notice: "Logged in"
  else
    flash.now[:alert] = "Invalid email or password"
    render :new, status: :unprocessable_entity
  end
end


  def destroy
    session[:user_id] = nil
    redirect_to login_path, notice: "Logged out"
  end
end

----- app/controllers/tables_controller.rb -----
class TablesController < ApplicationController
  def index
    @tables = Table.all
  end
end

===== app/controllers/staff (all) =====

----- app/controllers/staff/categories_controller.rb -----
class Staff::CategoriesController < ApplicationController
  layout "staff"
  before_action :require_login
  before_action :set_category, only: [:show, :edit, :update, :destroy]

  def index
    @categories = Category.order(:name)
  end

  def show; end

  def new
    @category = Category.new
  end

  def create
    @category = Category.new(category_params)
    if @category.save
      redirect_to staff_category_path(@category)
    else
      render :new
    end
  end

  def edit; end

  def update
    if @category.update(category_params)
      redirect_to staff_category_path(@category)
    else
      render :edit
    end
  end

  def destroy
    @category.destroy
    redirect_to staff_categories_path
  end

  private

  def set_category
    @category = Category.find(params[:id])
  end

  def category_params
    params.require(:category).permit(:name)
  end

  def require_login
    redirect_to login_path unless current_user&.staff?
  end

  def current_user
    @current_user ||= User.find(session[:user_id]) if session[:user_id]
  end
end

----- app/controllers/staff/menu_items_controller.rb -----
class Staff::MenuItemsController < ApplicationController
  layout "staff"
  before_action :require_login
  before_action :set_menu_item, only: [:show, :edit, :update, :destroy]

  def index
    @menu_items = MenuItem.includes(:category).order(:name)
  end

  def show; end

  def new
    @menu_item = MenuItem.new
  end

  def create
    @menu_item = MenuItem.new(menu_item_params)
    if @menu_item.save
      redirect_to staff_menu_item_path(@menu_item)
    else
      render :new
    end
  end

  def edit; end

  def update
    if @menu_item.update(menu_item_params)
      redirect_to staff_menu_item_path(@menu_item)
    else
      render :edit
    end
  end

  def destroy
    @menu_item.destroy
    redirect_to staff_menu_items_path
  end

  private

  def set_menu_item
    @menu_item = MenuItem.find(params[:id])
  end

  def menu_item_params
    params.require(:menu_item).permit(:name, :price, :category_id)
  end

  def require_login
    redirect_to login_path unless current_user&.staff?
  end

  def current_user
    @current_user ||= User.find(session[:user_id]) if session[:user_id]
  end
end

----- app/controllers/staff/order_items_controller.rb -----
# app/controllers/staff/order_items_controller.rb
class Staff::OrderItemsController < ApplicationController
  layout "staff"
  before_action :require_login

  def update
    @order_item = OrderItem.includes(:menu_item, :order).find(params[:id])

    unless params[:status].in?(%w[accepted denied])
      return redirect_back fallback_location: staff_orders_path, alert: "Invalid status"
    end

    @order_item.update!(status: params[:status])

    respond_to do |format|
      format.html { redirect_back fallback_location: staff_order_path(@order_item.order), notice: "Item updated" }
      format.turbo_stream
    end
  end

  private

  def require_login
    redirect_to login_path unless current_user&.staff?
  end

  def current_user
    @current_user ||= User.find(session[:user_id]) if session[:user_id]
  end
end

----- app/controllers/staff/orders_controller.rb -----
class Staff::OrdersController < ApplicationController
  before_action :require_login

  def index
    @orders = Order.includes(:table, order_items: :menu_item).order(created_at: :desc)
  end

  def show
    @order = Order.includes(order_items: :menu_item).find(params[:id])
  end

  def update
    @order = Order.find(params[:id])
    if params[:status].in?(%w[accepted denied])
      if @order.update(status: params[:status])
        respond_to do |format|
          format.html { redirect_to staff_orders_path, notice: "Order updated" }
          format.turbo_stream
        end
      else
        redirect_to staff_orders_path, alert: "Failed to update order"
      end
    else
      redirect_to staff_orders_path, alert: "Invalid status"
    end
  end

  private

  def require_login
    redirect_to login_path, alert: "Please log in as staff" unless current_user&.staff?
  end

  def current_user
    @current_user ||= User.find(session[:user_id]) if session[:user_id]
  end
end

----- app/controllers/staff/tables_controller.rb -----
class Staff::TablesController < ApplicationController
  layout "staff"
  before_action :require_login

  def index
    @tables = Table.all
  end

  def qr_code
    table = Table.find(params[:id])
    require "rqrcode"
    require "chunky_png"

    qrcode = RQRCode::QRCode.new(
      Rails.application.routes.url_helpers.new_table_order_url(
        table.qr_token,
        host: "localhost:3000"
      )
    )

    png = qrcode.as_png(
      bit_depth: 1,
      border_modules: 4,
      color_mode: ChunkyPNG::COLOR_GRAYSCALE,
      color: "black",
      fill: "white",
      module_px_size: 6,
      size: 240
    )

    send_data png.to_s,
      type: "image/png",
      disposition: "attachment",
      filename: "table_#{table.number}_qr.png"
  end

  private

  def require_login
    redirect_to login_path unless current_user&.staff?
  end

  def current_user
    @current_user ||= User.find(session[:user_id]) if session[:user_id]
  end
end

===== app/views/layouts =====

----- app/views/layouts/application.html.erb -----
<!DOCTYPE html>
<html>
  <head>
    <title>QrTableOrdering</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body>
    <%= yield %>
  </body>
</html>

----- app/views/layouts/mailer.html.erb -----
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style>
      /* Email styles need to be inline */
    </style>
  </head>

  <body>
    <%= yield %>
  </body>
</html>

----- app/views/layouts/mailer.text.erb -----
<%= yield %>

----- app/views/layouts/staff.html.erb -----
<!DOCTYPE html>
<html>
  <head>
    <title>Staff Area</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body>
    <%= render "staff/shared/nav" %>
    <%= yield %>
  </body>
</html>

===== app/views/staff (erb) =====

----- app/views/staff/categories/edit.html.erb -----
<h1>Edit Category</h1>

<%= form_with model: [:staff, @category] do |f| %>
  <div>
    <%= f.label :name %><br />
    <%= f.text_field :name %>
  </div>

  <div>
    <%= f.submit "Update" %>
  </div>
<% end %>

<p><%= link_to "Back", staff_categories_path %></p>

----- app/views/staff/categories/index.html.erb -----
<h1>Categories</h1>
<ul>
  <% @categories.each do |c| %>
    <li>
      <%= link_to c.name, staff_category_path(c) %>
      (<%= link_to "Edit", edit_staff_category_path(c) %>)
      <%= button_to "Delete", staff_category_path(c), method: :delete, data: { turbo_confirm: "Delete category?" } %>
    </li>
  <% end %>
</ul>

----- app/views/staff/categories/new.html.erb -----
<h1>New Category</h1>

<%= form_with model: [:staff, @category] do |f| %>
  <div>
    <%= f.label :name %><br />
    <%= f.text_field :name %>
  </div>

  <div>
    <%= f.submit "Create" %>
  </div>
<% end %>

<p><%= link_to "Back", staff_categories_path %></p>

----- app/views/staff/categories/show.html.erb -----
<h1><%= @category.name %></h1>

<p>
  <%= link_to "Edit", edit_staff_category_path(@category) %> |
  <%= link_to "Back", staff_categories_path %>
</p>

----- app/views/staff/menu_items/edit.html.erb -----
<h1>Edit Menu Item</h1>

<%= form_with model: [:staff, @menu_item] do |f| %>
  <div>
    <%= f.label :name %><br />
    <%= f.text_field :name %>
  </div>

  <div>
    <%= f.label :category_id, "Category" %><br />
    <%= f.collection_select :category_id, Category.order(:name), :id, :name, prompt: "Choose..." %>
  </div>

  <div>
    <%= f.label :price %><br />
    <%= f.number_field :price, step: 0.01 %>
  </div>

  <div>
    <%= f.submit "Update" %>
  </div>
<% end %>

<p><%= link_to "Back", staff_menu_items_path %></p>

----- app/views/staff/menu_items/index.html.erb -----
<h1>Menu Items</h1>
<table border="1" cellspacing="0" cellpadding="5">
  <p><%= link_to "New Menu Item", new_staff_menu_item_path %></p>

  <tr>
    <th>Name</th>
    <th>Category</th>
    <th>Price</th>
    <th>Actions</th>
  </tr>

  <% @menu_items.each do |m| %>
    <tr>
      <td><%= link_to m.name, staff_menu_item_path(m) %></td>
      <td><%= m.category&.name %></td>
      <td><%= m.price %></td>
      <td>
        <%= link_to "Edit", edit_staff_menu_item_path(m) %>
        <%= button_to "Delete", staff_menu_item_path(m), method: :delete, data: { turbo_confirm: "Delete menu item?" } %>
      </td>
    </tr>
  <% end %>
</table>

----- app/views/staff/menu_items/new.html.erb -----
<h1>New Menu Item</h1>

<%= form_with model: [:staff, @menu_item] do |f| %>
  <div>
    <%= f.label :name %><br />
    <%= f.text_field :name %>
  </div>

  <div>
    <%= f.label :category_id, "Category" %><br />
    <%= f.collection_select :category_id, Category.order(:name), :id, :name, prompt: "Choose..." %>
  </div>

  <div>
    <%= f.label :price %><br />
    <%= f.number_field :price, step: 0.01 %>
  </div>

  <div>
    <%= f.submit "Create" %>
  </div>
<% end %>

<p><%= link_to "Back", staff_menu_items_path %></p>

----- app/views/staff/menu_items/show.html.erb -----
<h1><%= @menu_item.name %></h1>

<p>Category: <%= @menu_item.category&.name %></p>
<p>Price: <%= @menu_item.price %></p>

<p>
  <%= link_to "Edit", edit_staff_menu_item_path(@menu_item) %> |
  <%= link_to "Back", staff_menu_items_path %>
</p>

----- app/views/staff/order_items/update.turbo_stream.erb -----
<%= turbo_stream.replace dom_id(@order_item) do %>
  <tr id="<%= dom_id(@order_item) %>">
    <td><%= @order_item.menu_item.name %></td>
    <td><%= @order_item.quantity %></td>
    <td><%= @order_item.status %></td>
    <td>
      <% if @order_item.pending? %>
        <%= button_to "Accept item", staff_order_item_path(@order_item, status: "accepted"), method: :patch %>
        <%= button_to "Deny item", staff_order_item_path(@order_item, status: "denied"), method: :patch %>
      <% else %>
        <em>No actions</em>
      <% end %>
    </td>
  </tr>
<% end %>

----- app/views/staff/orders/index.html.erb -----
<h1>All Orders</h1>

<table border="1" cellspacing="0" cellpadding="6">
  <thead>
    <tr>
      <th>ID</th>
      <th>Table</th>
      <th>Status</th>
      <th>Items</th>
      <th>Actions</th>
    </tr>
  </thead>

  <tbody>
    <% @orders.each do |order| %>
      <%= render partial: "staff/orders/order_row", locals: { order: order } %>
    <% end %>
  </tbody>
</table>

----- app/views/staff/orders/_order_row.html.erb -----
<tr id="<%= dom_id(order) %>">
  <td><%= link_to order.id, staff_order_path(order) %></td>
  <td><%= order.table.number %></td>
  <td><%= order.status %></td>
  <td>
    <ul>
      <% order.order_items.each do |oi| %>
        <li><%= oi.menu_item.name %> x <%= oi.quantity %> (<%= oi.status %>)</li>
      <% end %>
    </ul>
  </td>
  <td>
    <%= button_to "Pending", staff_order_path(order, status: "pending"),
          method: :patch, form: { data: { turbo: true } } %>
    <%= button_to "Accept", staff_order_path(order, status: "accepted"),
          method: :patch, form: { data: { turbo: true } } %>
    <%= button_to "Processing", staff_order_path(order, status: "processing"),
          method: :patch, form: { data: { turbo: true } } %>
    <%= button_to "Deny", staff_order_path(order, status: "denied"),
          method: :patch, form: { data: { turbo: true } } %>
  </td>
</tr>

----- app/views/staff/orders/show.html.erb -----
<h1>Order <%= @order.id %> (Table <%= @order.table.number %>)</h1>
<p>Order Status: <strong><%= @order.status %></strong></p>

<table border="1" cellspacing="0" cellpadding="6">
  <thead>
    <tr>
      <th>Item</th>
      <th>Qty</th>
      <th>Item Status</th>
      <th>Actions</th>
    </tr>
  </thead>

  <tbody>
    <% @order.order_items.each do |oi| %>
      <tr id="<%= dom_id(oi) %>">
        <td><%= oi.menu_item.name %></td>
        <td><%= oi.quantity %></td>
        <td><%= oi.status %></td>
        <td>
          <% if oi.pending? %>
            <%= button_to "Accept item", staff_order_item_path(oi, status: "accepted"), method: :patch %>
            <%= button_to "Deny item", staff_order_item_path(oi, status: "denied"), method: :patch %>
          <% else %>
            <em>No actions</em>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<p><%= link_to "Back", staff_orders_path %></p>

----- app/views/staff/orders/update.html.erb -----
<h1>Staff::Orders#update</h1>
<p>Find me in app/views/staff/orders/update.html.erb</p>

----- app/views/staff/orders/update.turbo_stream.erb -----
<%= turbo_stream.replace dom_id(@order) do %>
  <%= render partial: "staff/orders/order_row", locals: { order: @order } %>
<% end %>

----- app/views/staff/shared/_nav.html.erb -----
<nav>
  <%= link_to "Orders", staff_orders_path %> |
  <%= link_to "Tables & QR Codes", staff_tables_path %> |
  <%= link_to "Menu Items", staff_menu_items_path %> |
  <%= link_to "Categories", staff_categories_path %> |
  <%= button_to "Logout", logout_path, method: :delete, form: { data: { turbo: false } } %>
</nav>

<hr>

----- app/views/staff/tables/index.html.erb -----
<h1>Tables QR Codes</h1>

<% @tables.each do |table| %>
  <h2>Table <%= table.number %></h2>
  <%= raw table.qr_code %>
  <hr>
<% end %>

===== app/views/orders (erb) =====

----- app/views/orders/create.html.erb -----
<h1>Orders#create</h1>
<p>Find me in app/views/orders/create.html.erb</p>

----- app/views/orders/new.html.erb -----
<h1>Menu for Table <%= @table.number %></h1>

<%= form_with url: table_orders_path(@table.qr_token), method: :post, local: true do %>
  <% index = 0 %>

  <% @categories.each do |category| %>
    <h2><%= category.name %></h2>

    <% category.menu_items.each do |item| %>
      <div style="margin-bottom: 10px;">
        <strong><%= item.name %></strong>
        ($<%= item.price %>)

        <input type="hidden"
               name="order[order_items_attributes][<%= index %>][menu_item_id]"
               value="<%= item.id %>">

        <input type="number"
               name="order[order_items_attributes][<%= index %>][quantity]"
               value="0"
               min="0"
               style="width: 60px; margin-left: 10px;">
      </div>

      <% index += 1 %>
    <% end %>
  <% end %>

  <button type="submit" style="padding: 6px 12px; font-size: 16px;">
    Submit Order
  </button>
<% end %>

----- app/views/orders/_order.html.erb -----
<h1>Order <%= order.id %> (Table <%= table.number %>)</h1>
<p>Status: <strong><%= order.status %></strong></p>

<h2>Items</h2>
<ul>
  <% order.order_items.each do |oi| %>
    <li id="<%= dom_id(oi) %>">
      <%= render partial: "orders/order_item", locals: { oi: oi } %>
    </li>
  <% end %>
</ul>

----- app/views/orders/_order_item.html.erb -----
<%= oi.menu_item.name %> x <%= oi.quantity %> â€” <strong><%= oi.status %></strong>

----- app/views/orders/show.html.erb -----
<%= turbo_stream_from "order_#{@order.id}" %>

<div id="<%= dom_id(@order) %>">
  <%= render partial: "orders/order", locals: { order: @order, table: @table } %>
</div>
